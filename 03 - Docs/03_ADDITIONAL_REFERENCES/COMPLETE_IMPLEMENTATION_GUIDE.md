# Complete Nextion HMI Implementation for Stone Bridge Saw

## Overview

This document provides everything you need to build and deploy the stone bridge saw positioning controller HMI on your Nextion 7.0" display.

## The Challenge with .HMI Files

Nextion's `.hmi` files are **compiled binary resources**. They can only be:
1. **Generated by Nextion Editor** after you create a project
2. **Imported into Nextion Editor** for decompiling/reverse engineering (rarely works perfectly)

There is **no standard way** to generate a `.hmi` from scratch without going through the editor.

## Best Approach: Use Nextion Editor (Recommended)

### Option 1: Create Project From Scratch (30 minutes)

Follow the manual setup guide in `NEXTION_EDITOR_MANUAL_SETUP.md` - this gives you complete control and you'll understand every element.

### Option 2: Start With a Template

If you have an existing Nextion project file (`.nex`), you can modify it as a starting point.

---

## File Types Explained

| File Type | Format | Purpose | Editable |
|-----------|--------|---------|----------|
| `.nex` | Text/XML | Nextion Editor project file | Yes (in Editor) |
| `.hmi` | Binary | Compiled resource for display | No (binary) |
| `.tft` | Binary | Compiled firmware image | No (binary) |
| `.nva` | JSON | Visual attributes (newer format) | Yes (text) |

---

## Communication Protocol for Your PLC

Once the HMI is deployed, use this protocol for UART communication:

### From Nextion to PLC (115200 baud):

```
MOVE:X,100.5\n       # Move X to 100.5 mm
JOG:Y,10\n           # Jog Y by 10 mm positive
JOG:Z,-5\n           # Jog Z by 5 mm negative
HOME:X,0\n           # Home X axis
HOME:ALL,0\n         # Home all axes
STOP:ALL\n           # Emergency stop
```

### From PLC to Nextion:

```
POS:X,50.25\n        # Update X position display
POS:Y,100.5\n        # Update Y position display
POS:Z,75.0\n         # Update Z position display
STATUS:READY\n       # System status
STATUS:MOVING\n      # System status
```

---

## Key Objects and Their Purpose

### Page 0 - Main Dashboard

| Object | Type | Purpose |
|--------|------|---------|
| `btn_x` | Button | Navigate to X-Axis control (Page 1) |
| `btn_y` | Button | Navigate to Y-Axis control (Page 2) |
| `btn_z` | Button | Navigate to Z-Axis control (Page 3) |
| `btn_home_all` | Button | Command to home all axes |
| `btn_stop` | Button | Emergency stop |
| `x_val`, `y_val`, `z_val` | Text | Display current position |
| `feed_val` | Text | Display current feed rate |

### Pages 1-3 - Axis Controls

Each axis page contains:

| Object | Type | Purpose |
|--------|------|---------|
| `target_x/y/z` | Number Input | User enters target position |
| `jog_dist_x/y/z` | Number Input | User sets jog increment |
| `btn_move_x/y/z` | Button | Execute move to target |
| `btn_left/right` or `btn_up/down` | Button | Jog in direction |
| `btn_home_x/y/z` | Button | Home individual axis |
| `btn_stop_x/y/z` | Button | Stop axis motion |
| `gcode_x/y/z` | Text Display | Show generated GCode |
| `curr_val_x/y/z` | Text | Current position display |

---

## PLC Implementation Example (Arduino/C-like pseudocode)

```cpp
#include <SoftwareSerial.h>

// UART Communication
SoftwareSerial nextion(10, 11); // RX, TX

void setup() {
  nextion.begin(115200);
  Serial.begin(115200); // For debugging
}

void loop() {
  // Read from Nextion
  if (nextion.available()) {
    String command = nextion.readStringUntil('\n');
    
    if (command.startsWith("MOVE:X")) {
      float target = command.substring(7).toFloat();
      moveAxisX(target);
      updateDisplay();
    }
    else if (command.startsWith("JOG:X")) {
      float distance = command.substring(6).toFloat();
      jogAxisX(distance);
      updateDisplay();
    }
    else if (command.startsWith("HOME:X")) {
      homeAxisX();
      updateDisplay();
    }
    else if (command.startsWith("STOP:ALL")) {
      emergencyStop();
    }
  }
  
  // Send position updates (every 100ms)
  if (millis() - lastUpdate > 100) {
    float x = readPositionX();
    float y = readPositionY();
    float z = readPositionZ();
    
    nextion.print("POS:X,");
    nextion.println(x);
    nextion.print("POS:Y,");
    nextion.println(y);
    nextion.print("POS:Z,");
    nextion.println(z);
    
    lastUpdate = millis();
  }
}

void moveAxisX(float target) {
  // Generate GCode
  char gcode[50];
  sprintf(gcode, "G00 X%.3f F1000\n", target);
  
  // Send to motion controller
  sendGCodeCommand(gcode);
}

void updateDisplay() {
  // Update position values on screen
  nextion.print("x_val.txt=\"");
  nextion.print(readPositionX());
  nextion.println(" mm\"");
}
```

---

## Uploading to Nextion Display

### Method 1: Micro SD Card (Recommended)

1. Format a Micro SD card (FAT32)
2. Copy your `.hmi` file to the root directory
3. Insert SD card into Nextion display
4. Power cycle the display
5. Display will auto-update from SD card

### Method 2: Serial Upload

1. Use Nextion Editor's upload feature
2. Connect display to PC via USB-UART adapter
3. Baud rate: 115200
4. File â†’ Download to Device

### Method 3: UART/Serial Upload (Manual)

Use a terminal program and the Nextion upload protocol (advanced).

---

## Troubleshooting

### "Resource Has Been Damaged"

This error appears when:
1. `.hmi` file is corrupted
2. File was not properly compiled
3. Wrong display model selected
4. Partial file transfer

**Solution:**
- Delete the `.hmi` from SD card
- Recompile in Nextion Editor
- Re-upload cleanly

### Display Won't Update

1. Check UART connections (5V, GND, TX, RX)
2. Verify baud rate: 115200
3. Check PLC is sending data correctly
4. Monitor with serial sniffer (like Putty at 115200)

### Touch Not Responding

1. Check display is receiving 5V
2. Touch calibration may be needed
3. Try pressing screen edges
4. If stuck, perform factory reset

### GCode Not Showing

1. Button release events may not be configured
2. Check object names match your code
3. Verify text fields are not read-only

---

## Customization Tips

### Add More Positions

In each axis page, add preset buttons:

```
btn_pos1: pos1=100.0
btn_pos2: pos2=250.5
btn_pos3: pos3=500.0
```

### Change Colors

Update the BG color (bco) value for any object:
- Dark: 0x0000 (black)
- Light: 0xFFFF (white)
- Red: 0xF800
- Green: 0x07E0
- Blue: 0x001F
- Custom: Calculate using RGB565 format

### Add Feed Rate Control

Add another number input for feed rate:
```
feed_input: input field (1-2000 mm/min)
```

Then modify button events to use the variable:
```
print "GCODE:G00 X",target_x.val," F",feed_input.val,"\n"
```

### Add Status Messages

Create text displays for:
- System state (IDLE, MOVING, ERROR)
- Position error warnings
- Connection status

---

## Performance Considerations

1. **Update Rate:** Send position updates every 100-200ms for smooth display
2. **Command Queue:** PLC should handle rapid button presses
3. **Timeout:** Implement 5-second timeout for position updates (communication loss detection)
4. **Buffer Size:** Nextion has limited serial buffer (~512 bytes)

---

## Safety Checklist

- [ ] Emergency stop is hardware-independent (not reliant on Nextion)
- [ ] Position limits enforced in PLC, not just display
- [ ] Communication loss detection implemented
- [ ] Manual override capability exists
- [ ] All axes home correctly after power loss
- [ ] Feed rates are validated (no extreme speeds)
- [ ] Collision detection active in PLC

---

## Resources

- **Nextion Official:** https://nextion.tech/
- **GCode Reference:** https://www.reprap.org/wiki/G-code
- **Arduino UART:** https://www.arduino.cc/en/Tutorial/SoftwareSerialExample
- **Nextion Instruction Set:** https://nextion.tech/instruction-set/

---

## Support

If you encounter issues:
1. Check this troubleshooting section
2. Review the manual setup guide
3. Test UART communication with a serial monitor
4. Verify all object names in your code match the HMI
5. Try the Nextion forums: https://forum.nextion.tech/

